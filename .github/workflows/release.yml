name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.3.0

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Build nct-id binary
        run: |
          gcc -std=c2x -O2 -Wall -Wextra -Werror \
              -o nct-id scripts/nct-id.c
          strip nct-id  # Remove debug symbols for smaller binary
          chmod +x nct-id

      - name: Create source tarball
        run: |
          VERSION=${{ steps.version.outputs.version }}
          tar -czf "asus-b550-config-${VERSION}.tar.gz" \
            --exclude='.git*' \
            --exclude='node_modules' \
            --exclude='*.tar.gz' \
            --transform "s,^,asus-b550-config-${VERSION}/," \
            .

      - name: Generate checksums
        run: |
          sha256sum nct-id > nct-id.sha256
          sha256sum asus-b550-config-*.tar.gz > source.sha256

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}
          # Extract changelog section for this version
          awk "/## \[${VERSION}\]/,/## \[/" CHANGELOG.md | \
            head -n -1 | tail -n +2 > /tmp/release-notes.md
          
          # If no specific version notes, use generic message
          if [ ! -s /tmp/release-notes.md ]; then
            echo "Release version ${VERSION}" > /tmp/release-notes.md
            echo "" >> /tmp/release-notes.md
            echo "See CHANGELOG.md for details." >> /tmp/release-notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: /tmp/release-notes.md
          files: |
            nct-id
            nct-id.sha256
            asus-b550-config-*.tar.gz
            source.sha256
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'rc') || contains(steps.version.outputs.version, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-arch-package:
    name: Build Arch Linux Package
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup build environment
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel namcap git

      - name: Create build user
        run: |
          useradd -m builder
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
          chown -R builder:builder .

      - name: Build package
        run: |
          su builder -c "makepkg -sf --noconfirm"

      - name: Run namcap
        run: |
          namcap PKGBUILD || true
          namcap *.pkg.tar.* || true

      - name: Upload package artifact
        uses: actions/upload-artifact@v5
        with:
          name: arch-package
          path: '*.pkg.tar.*'
          retention-days: 30
