name: Changelog

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]

permissions:
  pull-requests: write
  contents: read

jobs:
  check-changelog:
    name: Check Changelog Updated
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if CHANGELOG.md was updated
        id: changelog-check
        run: |
          # Check if CHANGELOG.md was modified in this PR
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md"; then
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "✓ CHANGELOG.md has been updated"
          else
            echo "updated=false" >> $GITHUB_OUTPUT
            echo "⚠ CHANGELOG.md has NOT been updated"
          fi

      - name: Comment on PR if changelog not updated
        if: steps.changelog-check.outputs.updated == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Reminder**: Please update `CHANGELOG.md` with your changes.\n\nSee [Keep a Changelog](https://keepachangelog.com/) for format guidelines.'
            })

  validate-changelog-format:
    name: Validate Changelog Format
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate changelog format
        run: |
          # Check for required sections
          grep -q "## \[Unreleased\]" CHANGELOG.md || (echo "Missing [Unreleased] section" && exit 1)
          grep -q "### Added" CHANGELOG.md || echo "Note: No 'Added' section found"
          grep -q "### Changed" CHANGELOG.md || echo "Note: No 'Changed' section found"
          grep -q "### Fixed" CHANGELOG.md || echo "Note: No 'Fixed' section found"
          
          # Check for proper versioning format
          grep -E "\[([0-9]+\.[0-9]+\.[0-9]+)\]" CHANGELOG.md || echo "Note: No version tags found"
          
          echo "✓ Changelog format validation passed"
